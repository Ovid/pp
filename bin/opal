#!/usr/bin/env node

import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

// Get the directory name of the current module
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Construct an absolute path to Opal.js
const opalPath = path.resolve(__dirname, '../js/src/Opal.js');

// Import Opal using the absolute path
const { Opal } = await import(opalPath);

const args = process.argv.slice(2);
const opal = new Opal({ quiet: true });

if (args.length === 0) {
    console.error('Please provide a file to run, or use the -e flag to execute code.');
    process.exit(1);
}

if (args[0] === '-e') {
    const code = args[1];
    if (!code) {
        console.error('Error: -e requires an argument');
        process.exit(1);
    }
    opal.run([code]);
} else {
    const file = args[0];
    fs.readFile(file, 'utf8', (err, data) => {
        if (err) {
            console.error(`Error reading file: ${err.message}`);
            process.exit(1);
        }

        const lines = data.split('\n');
        if (lines[0].startsWith('#!')) {
            lines.shift();
        }

        opal.run(lines);
    });
}
